var dataset,dataByDay,xScale,xScaleForBins,yScale,yScaleForBins,zScale,yAxis,xAxis,currentWeek,startDate,margin={top:20,right:10,bottom:20,left:70},pad=margin.left-margin.right,w=780-margin.left-margin.right,h=440-margin.top-margin.bottom,svg=d3.select("#main").append("svg:svg").attr("width",w+margin.left+margin.right).attr("height",h+margin.top+margin.bottom).append("svg:g").attr("transform","translate("+margin.left+","+margin.top+")"),dates=["2019-01-01","2019-01-02","2019-01-03","2019-01-04","2019-01-05","2019-01-06","2018-12-31"];d3.json("weeks.min.json",function(t,a){if(t)return console.warn(t);weeks=a.Weeks,currentWeek=weeks[0],loadFirstWeek(currentWeek)});var loadData=function(t){var a=(startDate=new Date(t["Start Date"])).getFullYear(),e=startDate.getMonth(),n=startDate.getDate(),r=startDate.getDay();for(1!==r&&(startDate=new Date(a,e,n-(r-1))),dataByDay=[],dataset=d3.layout.histogram().value(function(t){return t.blood_glucose}).bins(yScaleForBins.ticks(20))(t["Timestamped Readings"]),i=0;i<dataset.length;i++)data=d3.layout.histogram().value(function(t){var a=new Date(t.timestamp).getDay();return 0===a&&(a=7),a}).bins(xScaleForBins.ticks(7))(dataset[i]),dataByDay.push(data)},loadFirstWeek=function(t){for(yScaleForBins=d3.scale.linear().domain([20,420]).range([h,0]),xScaleForBins=d3.scale.linear().domain([1,8]).range([0,w]),xScale=d3.scale.linear().domain([0,7]).range([0,w]),loadData(t),$("#week-of").html("Week of "+startDate.toDateString()),yScale=d3.scale.linear().domain([0,dataByDay.length]).range([h,0]),zScale=d3.scale.linear().domain(d3.extent(dataByDay,function(t){return d3.max(t,function(t){return t.y})})).range(["white","purple"]).interpolate(d3.interpolateLab),yAxis=d3.svg.axis().scale(yScaleForBins).orient("left"),xAxis=d3.svg.axis().scale(xScale).orient("bottom").tickFormat(function(t){var a=new Date(dates[t]);return d3.time.format("%A")(a)}),j=0;j<dataByDay.length;j++)data=dataByDay[j],svg.selectAll(".bin_"+j).data(data).enter().append("svg:rect").attr({x:function(t){return xScaleForBins(t.x)},y:function(){return yScale(j)-yScale(dataByDay.length-1)},width:function(t){return xScaleForBins(2)},height:function(t){return yScale(dataByDay.length-1)},fill:function(t){return zScale(t.y)},class:"bin_"+j,"data-toggle":"popover"}).attr("title",function(){var t=dataByDay.length-j-1;return"Between "+Math.round(yScale(t))+" and "+parseInt(Math.round(yScale(t))+20)+" mg/dL"}).attr("data-content",function(t){var a=$(this).attr("class");return $(this).attr("class",a.replace(" no_readings","")),a=$(this).attr("class"),1===t.y?t.y+" reading":0===t.y?($(this).attr("class",a+" no_readings"),t.y+" readings"):t.y+" readings"});$("[class^=bin]").popover({trigger:"hover",container:"#top",html:!0}),$(".no_readings").popover("destroy"),svg.append("svg:g").attr("class","y axis").call(yAxis),svg.append("svg:g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(xAxis),svg.selectAll(".axis.x text").attr("dx",xScale(1)/2)},newWeek=function(t){for($("#week-of").html("Week of "+startDate.toDateString()),zScale.domain(d3.extent(dataByDay,function(t){return d3.max(t,function(t){return t.y})})).range(["white","purple"]).interpolate(d3.interpolateLab),j=0;j<dataByDay.length;j++)data=dataByDay[j],svg.selectAll(".bin_"+j).data(data).transition().delay(function(a,e){return"previous"===t?575-25*e:25*e}).attr("width",function(){return.75*xScale(1)}).each("end",function(){d3.select(this).transition().ease("linear").attr({fill:function(t){return zScale(t.y)},width:function(){return xScale(1)}})}).attr("data-content",function(t){var a=$(this).attr("class");return $(this).attr("class",a.replace(" no_readings","")),a=$(this).attr("class"),1===t.y?t.y+" reading":0===t.y?($(this).attr("class",a+" no_readings"),t.y+" readings"):t.y+" readings"});$("[class^=bin]").popover("destroy"),$("[class^=bin]").data("content",function(){return $(this).attr("data-content")}),$("[class^=bin]").popover({trigger:"hover",container:"#top",html:!0}),$(".no_readings").popover("destroy")};d3.select("#next-week").on("click",function(){if(!$(this).hasClass("disabled")){var t=weeks.indexOf(currentWeek)+1;currentWeek=weeks[t],loadData(currentWeek),newWeek("next"),updateButton(t)}}),d3.select("#previous-week").on("click",function(){if(!$(this).hasClass("disabled")){var t=weeks.indexOf(currentWeek)-1;currentWeek=weeks[t],loadData(currentWeek),newWeek("previous"),updateButton(t)}});var updateButton=function(t){t>0&&t<weeks.length-1?$("#week-buttons button").removeClass("disabled"):0==t?$("#previous-week").addClass("disabled"):t==weeks.length-1&&$("#next-week").addClass("disabled")};